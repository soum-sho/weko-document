# v1.0.7 から v1.0.7b へのアップデート方法（jc-niirdc-rc-cnri3.repo）

kubectl-prで作業を行う。単一リポジトリの更新手順となっているため、複数対応のためには変更が必要である。

1. deploy-web.yaml のイメージバージョンを変更する。

```
nrjjxl1nnwb4/release/web:v1.0.7b
nrjjxl1nnwb4/release/nginx:v1.0.7b
```

```
cd /usr/local/share/deploy_logs/make_weko_manifests-current
sed -i 's/v1.0.7$/v1.0.7b/g' jc-niirdc-rc-cnri3.repo.nii.ac.jp/manifests/deploy-web.yaml

git diff
````

2. ingressを停止する。

```
kubectl delete -f /usr/local/share/deploy_logs/make_weko_manifests-current/jc-niirdc-rc-cnri3.repo.nii.ac.jp/manifests/ingress.yaml
```

3. deploy-web.yaml を適用する。


```
kubectl apply -f /usr/local/share/deploy_logs/make_weko_manifests-current/jc-niirdc-rc-cnri3.repo.nii.ac.jp/manifests/deploy-web.yaml
```

4. 変数を設定する。DBは更新系を指定する。

```
FQDN=jc-niirdc-rc-cnri3.repo.nii.ac.jp
DBNAME=$(echo $FQDN| tr "." "_" | tr "-" "_")
POD=$(kubectl get pods -n weko3 | grep ^$(echo $DBNAME|tr "_" "-")|cut -d' ' -f 1)
DB=weko-postgresql-2

declare -p FQDN DBNAME POD DB
```

5. プロパティを最新化する。

```
kubectl exec -n weko3 $POD -c web -- invenio shell scripts/demo/register_properties.py only_specified
```

6. アイテムタイプの状態を過去に戻す。日時は適切なものに置き換える。

```
kubectl exec -n weko3 $POD -c web -- invenio shell scripts/demo/replace_item_type_data.py "2024-09-08T15:00:00"
```

7. タイトルデータが破壊されている状態を正常に修正する。

```
kubectl exec -n weko3 $POD -c web -- invenio shell tools/itemtype_fix_form_title.py
```

8. アイテムタイプを再読み込みする。

```
kubectl exec -n weko3 $POD -c web -- invenio shell scripts/demo/renew_all_item_types.py only_specified VAL
```

9. 識別子のテーブルをアップデートする。

```
cd /fs-pgbackup/
sudo rm v1_0_7a2.sql
sudo wget https://raw.githubusercontent.com/RCOSDP/weko/refs/heads/release_v1.0.7b/postgresql/update/v1_0_7a2.sql

sudo cp -iv v1_0_7a2.sql v1_0_7a2.sql.original
sudo sed -i 's/schema/scheme/g' v1_0_7a2.sql
diff -uw v1_0_7a2.sql.original v1_0_7a2.sql

kubectl exec -n weko3pg $DB -c postgres -- ls -l /var/lib/postgresql/backup/v1_0_7a2.sql
kubectl exec -n weko3pg $DB -c postgres -- cat /var/lib/postgresql/backup/v1_0_7a2.sql
kubectl exec -n weko3pg $DB -- psql -U invenio $DBNAME -f /var/lib/postgresql/backup/v1_0_7a2.sql
```

10. 新規構築環境のテーブルをアップデートする。 

```
# jc-niirdc-rc-cnri3.repoはWEKO3で新規環境構築を行った機関であるため実施する
cd /fs-pgbackup/
sudo rm fix_itemtype_issue_45614.sql
sudo wget https://raw.githubusercontent.com/RCOSDP/weko/refs/heads/release_v1.0.7b/postgresql/ddl/fix_itemtype_issue_45614.sql

kubectl exec -n weko3pg $DB -c postgres -- ls -l /var/lib/postgresql/backup/fix_itemtype_issue_45614.sql
kubectl exec -n weko3pg $DB -- psql -U invenio $DBNAME -f /var/lib/postgresql/backup/fix_itemtype_issue_45614.sql
```

11. 新規環境構築機関のみ（=10の手順が適用された機関）、修正したアイテムタイプを再インデックスする。

```
# jc-niirdc-rc-cnri3.repoはWEKO3で新規環境構築を行った機関であるため実施する
kubectl exec -n weko3 $POD -c web -- invenio index reindex -t recid --item-type-id 30001
kubectl exec -n weko3 $POD -c web -- invenio index reindex -t recid --item-type-id 30002
```

12. Javascriptを最新化する。

```
kubectl exec -n weko3 $POD -c web -- invenio assets build
kubectl exec -n weko3 $POD -c web -- invenio collect
```

13. ingressを再開する。

```
kubectl apply -f /usr/local/share/deploy_logs/make_weko_manifests-current/jc-niirdc-rc-cnri3.repo.nii.ac.jp/manifests/ingress.yaml
```
